<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-"rwerwerew>rewrewrewrew
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Spend Analyzer - Pure JS (Firestore)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        /* Hidden by default, shown by JS */
        .page-section {
            display: none;
        }
        /* Custom alert animation */
        .custom-alert-container {
            position: fixed;
            top: 4rem; /* Adjusted top for visibility */
            left: 50%;
            transform: translateX(-50%) translateY(-100%); /* Start off-screen above */
            opacity: 0;
            transition: all 0.3s ease-out; /* Smooth transition */
            display: none; /* Hidden by default */
            pointer-events: none; /* Allows clicks underneath when hidden */
            z-index: 50; /* Ensure it's on top */
            max-width: 24rem; /* Tailwind max-w-sm */
            width: 90%; /* Responsive width */
        }
        .custom-alert-container.show {
            transform: translateX(-50%) translateY(0); /* Slide into view */
            opacity: 1;
            display: block; /* Make it visible */
            pointer-events: auto; /* Enable clicks when visible */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100">

    <!-- Custom Alert Container -->
    <div id="custom-alert-container" class="custom-alert-container p-4 rounded-lg shadow-xl border">
        <div class="flex justify-between items-center">
            <p id="custom-alert-message" class="font-semibold text-lg"></p>
            <button id="custom-alert-close" class="text-current text-2xl font-bold ml-4 leading-none">
                &times;
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 bg-white rounded-xl shadow-2xl mt-8 mb-8">

        <!-- Loading Indicator -->
        <div id="loading-spinner" class="text-center py-20 text-blue-600 font-medium text-2xl animate-pulse">
            Loading application...
        </div>

        <!-- Auth Page -->
        <div id="auth-page" class="page-section min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-8 font-sans antialiased flex flex-col items-center justify-center">
            <div class="bg-white p-10 rounded-xl shadow-2xl max-w-lg w-full text-center">
                <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Login</h1>
                <div id="logged-in-state" class="hidden">
                    <p class="text-lg text-gray-700 mb-4">You are currently logged in as:</p>
                    <p id="current-user-email" class="font-mono bg-gray-100 px-4 py-2 rounded-md text-lg text-blue-800 break-all"></p>
                    <button id="auth-logout-button-alt" class="mt-6 px-8 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-all duration-300 ease-in-out transform hover:scale-105">
                        Logout
                    </button>
                    <button id="go-to-app-button" class="mt-4 px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105 ml-4">
                        Go to App
                    </button>
                </div>
                <div id="login-form-state">
                    <form id="login-form" class="space-y-6">
                        <div>
                            <label for="email" class="sr-only">Email</label>
                            <input
                                type="email"
                                id="email"
                                placeholder="Email"
                                class="w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg transition duration-200 ease-in-out"
                                required
                            />
                        </div>
                        <div>
                            <label for="password" class="sr-only">Password</label>
                            <input
                                type="password"
                                id="password"
                                placeholder="Password"
                                class="w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg transition duration-200 ease-in-out"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            class="w-full py-3 px-6 border border-transparent rounded-lg shadow-md text-xl font-bold text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 ease-in-out transform hover:scale-105"
                        >
                            Login
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Content Area (Hidden by default, shown after login) -->
        <div id="main-content" class="page-section">
            <!-- Navigation Bar (Only visible when logged in) -->
            <div id="nav-bar" class="mb-8 flex justify-center space-x-4 md:space-x-6 flex-wrap">
                <button id="nav-home-button" class="px-4 py-2 md:px-6 md:py-3 rounded-full text-lg md:text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 bg-blue-600 text-white shadow-xl ring-4 ring-blue-300">
                    üìä Spend Analyzer
                </button>
                <button id="nav-history-button" class="px-4 py-2 md:px-6 md:py-3 rounded-full text-lg md:text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 bg-gray-200 text-gray-700 hover:bg-indigo-100">
                    üìö Historical Data
                </button>
                <button id="nav-settings-button" class="px-4 py-2 md:px-6 md:py-3 rounded-full text-lg md:text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 bg-gray-200 text-gray-700 hover:bg-purple-100">
                    ‚öôÔ∏è Settings
                </button>
                <button id="nav-logout-button" class="px-4 py-2 md:px-6 md:py-3 rounded-full text-lg md:text-xl font-bold transition-all duration-300 ease-in-out transform hover:scale-105 bg-red-600 text-white shadow-xl ring-4 ring-red-300 hover:bg-red-700">
                    üö™ Logout
                </button>
            </div>

            <!-- User ID Display -->
            <div id="user-id-display" class="text-center mb-4 text-sm text-gray-600">
                Current User ID: <span id="current-user-id" class="font-mono bg-gray-100 px-2 py-1 rounded-md break-all"></span>
            </div>
            <div id="user-email-display" class="text-center mb-4 text-sm text-gray-600">
                Logged in as: <span id="logged-in-email" class="font-semibold text-blue-800"></span>
            </div>

            <!-- Home Page Content -->
            <div id="home-page" class="page-section">
                <h1 class="text-5xl font-extrabold text-gray-900 mb-8 text-center drop-shadow-md">Home Spend Analyzer</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Transaction Form and Table -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Transaction Input Form -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-8 rounded-xl shadow-lg border border-blue-200 transform transition-transform duration-300 hover:scale-[1.005] hover:shadow-xl">
                            <h2 class="text-3xl font-bold text-blue-800 mb-6 border-b-2 border-blue-300 pb-3">Add New Transaction</h2>
                            <form id="transaction-form" class="space-y-6">
                                <div>
                                    <label for="transaction-category" class="block text-base font-semibold text-gray-700 mb-2">Category</label>
                                    <select id="transaction-category" class="mt-1 block w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base bg-white transition duration-200 ease-in-out" required>
                                        <!-- Categories will be loaded here by JS -->
                                        <option value="">No categories. Add in Settings.</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="transaction-description" class="block text-base font-semibold text-gray-700 mb-2">Description</label>
                                    <input
                                        type="text"
                                        id="transaction-description"
                                        placeholder="e.g., Groceries, Salary, Rent"
                                        class="mt-1 block w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base transition duration-200 ease-in-out"
                                        required
                                    />
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                    <div>
                                        <label for="transaction-amount" class="block text-base font-semibold text-gray-700 mb-2">Amount (‚Çπ)</label>
                                        <input
                                            type="number"
                                            id="transaction-amount"
                                            placeholder="e.g., 50.00"
                                            step="0.01"
                                            min="0"
                                            class="mt-1 block w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base transition duration-200 ease-in-out"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label for="transaction-date" class="block text-base font-semibold text-gray-700 mb-2">Date</label>
                                        <input
                                            type="date"
                                            id="transaction-date"
                                            class="mt-1 block w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-base transition duration-200 ease-in-out"
                                            required
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-base font-semibold text-gray-700 mb-2">Type</label>
                                    <div class="mt-1 flex space-x-6">
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="radio" name="transactionType" value="debit" class="form-radio h-5 w-5 text-red-600 transition duration-150 ease-in-out" checked />
                                            <span class="ml-3 text-gray-800 text-lg font-medium">Debit</span>
                                        </label>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="radio" name="transactionType" value="credit" class="form-radio h-5 w-5 text-green-600 transition duration-150 ease-in-out" />
                                            <span class="ml-3 text-gray-800 text-lg font-medium">Credit</span>
                                        </label>
                                    </div>
                                </div>
                                <button
                                    type="submit"
                                    class="w-full flex justify-center py-3 px-6 border border-transparent rounded-lg shadow-md text-xl font-bold text-white bg-blue-700 hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 ease-in-out transform hover:scale-105"
                                >
                                    Add Transaction
                                </button>
                            </form>
                        </div>

                        <!-- Transaction Table -->
                        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 overflow-x-auto transform transition-transform duration-300 hover:scale-[1.005] hover:shadow-xl">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-gray-300 pb-3">Transaction History</h2>
                            <div id="transactions-list-container">
                                <p id="no-transactions-message" class="text-gray-500 text-center py-6 text-lg">No transactions added yet. You need to login to add transactions!</p>
                                <table id="transactions-table" class="min-w-full divide-y divide-gray-200 hidden">
                                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider rounded-tl-lg">Date</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Description</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Category</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Type</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-600 uppercase tracking-wider rounded-tr-lg">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-table-body" class="bg-white divide-y divide-gray-100">
                                        <!-- Transactions will be rendered here by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Summary Cards and Chart -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- Summary Cards -->
                        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 transform transition-transform duration-300 hover:scale-[1.005] hover:shadow-xl">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-gray-300 pb-3">Financial Summary</h2>
                            <div class="space-y-6">
                                <div class="p-6 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg shadow-md border border-purple-200 flex flex-col items-center justify-center transform transition-transform duration-200 hover:scale-105">
                                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Current Balance</h3>
                                    <p id="current-balance" class="text-4xl font-extrabold text-gray-700 drop-shadow-sm">‚Çπ0.00</p>
                                </div>
                                <div class="p-6 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg shadow-md border border-yellow-200 flex flex-col items-center justify-center transform transition-transform duration-200 hover:scale-105">
                                    <h3 class="text-xl font-semibold text-yellow-800 mb-2 text-center">Balance as of 1st of Month</h3>
                                    <p id="balance-start-month" class="text-4xl font-extrabold text-gray-700 drop-shadow-sm">‚Çπ0.00</p>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Chart (Table version) -->
                        <div id="monthly-chart-container">
                            <!-- Chart will be rendered here by JS -->
                        </div>

                        <!-- Category Spend Chart (Table version) -->
                        <div id="category-spend-chart-container">
                            <!-- Chart will be rendered here by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Data Page Content -->
            <div id="history-page" class="page-section min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 p-8 font-sans antialiased">
                <h1 class="text-5xl font-extrabold text-blue-900 mb-10 text-center drop-shadow-lg">Historical Financial Data</h1>
                <button id="history-back-button" class="mb-8 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition-all duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 md:text-lg text-xl">
                    &larr; Back to Spend Analyzer
                </button>
                <div id="historical-data-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <p class="text-center text-gray-700 text-xl bg-white p-8 rounded-xl shadow-xl col-span-full">No historical data available. Please add some transactions on the Home page.</p>
                </div>
            </div>

            <!-- Settings Page Content -->
            <div id="settings-page" class="page-section min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-8 font-sans antialiased">
                <h1 class="text-5xl font-extrabold text-purple-900 mb-10 text-center drop-shadow-lg">Settings: Category Master</h1>
                <button id="settings-back-button" class="mb-8 px-5 py-2.5 bg-purple-600 text-white font-semibold rounded-full shadow-lg hover:bg-purple-700 transition-all duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300 md:text-lg text-xl">
                    &larr; Back to Spend Analyzer
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Add New Category Form -->
                    <div class="bg-white p-8 rounded-xl shadow-lg border border-purple-200 transform transition-transform duration-300 hover:scale-[1.005] hover:shadow-xl">
                        <h2 class="text-3xl font-bold text-purple-800 mb-6 border-b-2 border-purple-300 pb-3">Add New Category</h2>
                        <form id="add-category-form" class="space-y-6">
                            <div>
                                <label for="new-category-name" class="block text-base font-semibold text-gray-700 mb-2">Category Name</label>
                                <input
                                    type="text"
                                    id="new-category-name"
                                    placeholder="e.g., Food, Transport, Utilities"
                                    class="mt-1 block w-full px-5 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500 text-base transition duration-200 ease-in-out"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                class="w-full flex justify-center py-3 px-6 border border-transparent rounded-lg shadow-md text-xl font-bold text-white bg-purple-700 hover:bg-purple-800 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-300 ease-in-out transform hover:scale-105"
                            >
                                Add Category
                            </button>
                        </form>
                    </div>

                    <!-- Existing Categories List -->
                    <div class="bg-white p-8 rounded-xl shadow-lg border border-purple-200 transform transition-transform duration-300 hover:scale-[1.005] hover:shadow-xl">
                        <h2 class="text-3xl font-bold text-purple-800 mb-6 border-b-2 border-purple-300 pb-3">Existing Categories</h2>
                        <ul id="categories-list" class="space-y-4">
                            <p class="text-gray-500 text-center py-6 text-lg">No categories added yet.</p>
                        </ul>
                    </div>
                </div>
                <!-- Confirmation Modal for Category Delete -->
                <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
                    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 opacity-100">
                        <h3 class="text-2xl font-bold text-gray-800 mb-5 border-b-2 pb-3">Confirm Action</h3>
                        <p id="confirmation-message" class="text-lg text-gray-700 mb-6">Are you sure you want to delete this category?</p>
                        <div class="flex justify-end space-x-4">
                            <button id="cancel-delete-button" class="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                                Cancel
                            </button>
                            <button id="confirm-delete-button" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Reverting to Firestore imports
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global App State
        const appState = {
            db: null, // This will now hold Firestore instance
            auth: null,
            userId: null,
            transactions: [],
            categories: [],
            currentPage: 'auth', // 'auth', 'home', 'history', 'settings'
            loading: true,
            alert: { message: '', type: '', visible: false },
            categoryToDeleteId: null // To store the ID of the category being confirmed for deletion
        };

        // --- DOM Element References ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');

        // Alert Elements
        const customAlertContainer = document.getElementById('custom-alert-container');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertCloseBtn = document.getElementById('custom-alert-close');

        // Auth Page Elements
        const authPage = document.getElementById('auth-page');
        const loggedInState = document.getElementById('logged-in-state');
        const currentUserEmailDisplay = document.getElementById('current-user-email');
        const loginFormState = document.getElementById('login-form-state');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authLogoutButtonAlt = document.getElementById('auth-logout-button-alt');
        const goToAppButton = document.getElementById('go-to-app-button');

        // Main Content Elements (visible after login)
        const mainContent = document.getElementById('main-content');
        const navBar = document.getElementById('nav-bar');
        const navHomeButton = document.getElementById('nav-home-button');
        const navHistoryButton = document.getElementById('nav-history-button');
        const navSettingsButton = document.getElementById('nav-settings-button');
        const navLogoutButton = document.getElementById('nav-logout-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const currentUserIdSpan = document.getElementById('current-user-id');
        const userEmailDisplay = document.getElementById('user-email-display');
        const loggedInEmailSpan = document.getElementById('logged-in-email');

        // Home Page Elements
        const homePage = document.getElementById('home-page');
        const transactionForm = document.getElementById('transaction-form');
        const transactionCategorySelect = document.getElementById('transaction-category');
        const transactionDescriptionInput = document.getElementById('transaction-description');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const transactionDateInput = document.getElementById('transaction-date');
        const transactionTypeRadios = document.querySelectorAll('input[name="transactionType"]');
        const transactionsListContainer = document.getElementById('transactions-list-container');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const transactionsTable = document.getElementById('transactions-table');
        const transactionsTableBody = document.getElementById('transactions-table-body');
        const currentBalanceDisplay = document.getElementById('current-balance');
        const balanceStartMonthDisplay = document.getElementById('balance-start-month');
        const monthlyChartContainer = document.getElementById('monthly-chart-container');
        const categorySpendChartContainer = document.getElementById('category-spend-chart-container');

        // History Page Elements
        const historyPage = document.getElementById('history-page');
        const historyBackButton = document.getElementById('history-back-button');
        const historicalDataContent = document.getElementById('historical-data-content');

        // Settings Page Elements
        const settingsPage = document.getElementById('settings-page');
        const settingsBackButton = document.getElementById('settings-back-button');
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const categoriesList = document.getElementById('categories-list');

        // Confirmation Modal Elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');

        // --- Helper Functions ---

        /**
         * Displays a custom alert message at the top of the screen.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of alert for styling.
         */
        function showAlert(message, type) {
            console.log(`Attempting to show alert: "${message}" of type "${type}"`); // Debug log

            customAlertMessage.textContent = message;
            
            // Reset classes to ensure proper animation starts
            customAlertContainer.className = 'custom-alert-container p-4 rounded-lg shadow-xl border';

            let bgColor = '';
            let textColor = '';
            let borderColor = '';

            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                    borderColor = 'border-green-300';
                    break;
                case 'error':
                    bgColor = 'bg-red-100';
                    textColor = 'text-red-800';
                    borderColor = 'border-red-300';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-800';
                    borderColor = 'border-blue-300';
                    break;
                default:
                    bgColor = 'bg-gray-100';
                    textColor = 'text-gray-800';
                    borderColor = 'border-gray-300';
            }

            customAlertContainer.classList.add(bgColor, textColor, borderColor, 'show');
            appState.alert.visible = true; // Update internal state

            // Auto-hide after 5 seconds
            setTimeout(() => {
                customAlertContainer.classList.remove('show');
                appState.alert.visible = false; // Update internal state
                // Clear message content after transition to avoid stale data if re-shown quickly
                setTimeout(() => {
                    customAlertMessage.textContent = '';
                }, 300); // Match transition duration
            }, 5000);
        }

        /**
         * Clears and hides the custom alert immediately.
         */
        function hideAlert() {
            if (customAlertContainer.classList.contains('show')) {
                customAlertContainer.classList.remove('show');
                // Allow time for transition before clearing message
                setTimeout(() => {
                    customAlertMessage.textContent = ''; // Clear message content
                }, 300); // Match transition duration
            }
            appState.alert.visible = false; // Update internal state
        }

        /**
         * Shows a specific page section and hides others.
         * @param {HTMLElement} pageToShow - The DOM element of the page to show.
         */
        function showPage(pageToShow) {
            const allPages = [authPage, homePage, historyPage, settingsPage, mainContent];
            allPages.forEach(page => {
                if (page) { // Ensure the element exists
                    page.style.display = 'none';
                    if (page.classList.contains('min-h-screen')) {
                        page.classList.remove('flex', 'items-center', 'justify-center', 'flex-col'); // Remove flex for other pages
                    }
                }
            });

            // Specific display logic for each page
            if (pageToShow === authPage) {
                authPage.style.display = 'flex';
                authPage.classList.add('flex', 'items-center', 'justify-center', 'flex-col');
                loadingSpinner.style.display = 'none'; // Hide loading spinner once page content is shown
                appState.currentPage = 'auth';
            } else {
                mainContent.style.display = 'block'; // Show main content wrapper
                if (pageToShow) {
                    pageToShow.style.display = 'block';
                }
                loadingSpinner.style.display = 'none'; // Hide loading spinner once page content is shown
                if (pageToShow === homePage) appState.currentPage = 'home';
                if (pageToShow === historyPage) appState.currentPage = 'history';
                if (pageToShow === settingsPage) appState.currentPage = 'settings';
            }

            // Update nav button active states
            [navHomeButton, navHistoryButton, navSettingsButton].forEach(btn => {
                if (btn) {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-xl', 'ring-4', 'ring-blue-300', 'bg-indigo-600', 'ring-indigo-300', 'bg-purple-600', 'ring-purple-300');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
            if (appState.currentPage === 'home' && navHomeButton) {
                navHomeButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-blue-100');
                navHomeButton.classList.add('bg-blue-600', 'text-white', 'shadow-xl', 'ring-4', 'ring-blue-300');
            } else if (appState.currentPage === 'history' && navHistoryButton) {
                navHistoryButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-indigo-100');
                navHistoryButton.classList.add('bg-indigo-600', 'text-white', 'shadow-xl', 'ring-4', 'ring-indigo-300');
            } else if (appState.currentPage === 'settings' && navSettingsButton) {
                navSettingsButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-purple-100');
                navSettingsButton.classList.add('bg-purple-600', 'text-white', 'shadow-xl', 'ring-4', 'ring-purple-300');
            }
        }


        // --- Render Functions for UI Components ---

        /**
         * Renders the transaction table on the home page.
         */
        function renderTransactionsTable() {
            if (!transactionsTableBody) return; // Guard clause

            transactionsTableBody.innerHTML = ''; // Clear existing rows

            if (appState.transactions.length === 0) {
                noTransactionsMessage.classList.remove('hidden');
                transactionsTable.classList.add('hidden');
            } else {
                noTransactionsMessage.classList.add('hidden');
                transactionsTable.classList.remove('hidden');

                // Sort transactions by date descending
                const sortedTransactions = [...appState.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedTransactions.forEach(transaction => {
                    const row = transactionsTableBody.insertRow();
                    row.className = 'hover:bg-gray-50 transition-colors duration-150';

                    const dateCell = row.insertCell();
                    dateCell.className = 'px-4 py-3 whitespace-nowrap text-base font-medium text-gray-900';
                    dateCell.textContent = transaction.date;

                    const descriptionCell = row.insertCell();
                    descriptionCell.className = 'px-4 py-3 whitespace-nowrap text-base text-gray-700';
                    descriptionCell.textContent = transaction.description;

                    const categoryCell = row.insertCell();
                    categoryCell.className = 'px-4 py-3 whitespace-nowrap text-base text-gray-700';
                    categoryCell.textContent = transaction.category || 'N/A';

                    const typeCell = row.insertCell();
                    typeCell.className = 'px-4 py-3 whitespace-nowrap text-base';
                    const typeSpan = document.createElement('span');
                    typeSpan.className = `px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full ${
                        transaction.type === 'credit' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }`;
                    typeSpan.textContent = transaction.type === 'credit' ? 'Credit' : 'Debit';
                    typeCell.appendChild(typeSpan);

                    const amountCell = row.insertCell();
                    amountCell.className = `px-4 py-3 whitespace-nowrap text-right text-base ${
                        transaction.type === 'credit' ? 'text-green-600' : 'text-red-600'
                    }`;
                    amountCell.textContent = `‚Çπ${transaction.amount.toFixed(2)}`;
                });
            }
        }

        /**
         * Updates the current balance and balance at start of month displays.
         */
        function updateBalanceDisplays() {
            let currentBalance = appState.transactions.reduce((acc, transaction) => {
                return transaction.type === 'credit' ? acc + transaction.amount : acc - transaction.amount;
            }, 0);

            const today = new Date();
            const firstDayOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            firstDayOfCurrentMonth.setHours(0, 0, 0, 0);

            let balanceAtStartOfMonth = appState.transactions.reduce((acc, transaction) => {
                const transactionDate = new Date(transaction.date);
                transactionDate.setHours(0, 0, 0, 0);

                if (transactionDate < firstDayOfCurrentMonth) {
                    return transaction.type === 'credit' ? acc + transaction.amount : acc - transaction.amount;
                }
                return acc;
            }, 0);

            if (currentBalanceDisplay) {
                currentBalanceDisplay.textContent = `‚Çπ${currentBalance.toFixed(2)}`;
                currentBalanceDisplay.className = `text-4xl font-extrabold ${currentBalance >= 0 ? 'text-green-700' : 'text-red-700'} drop-shadow-sm`;
            }
            if (balanceStartMonthDisplay) {
                balanceStartMonthDisplay.textContent = `‚Çπ${balanceAtStartOfMonth.toFixed(2)}`;
                balanceStartMonthDisplay.className = `text-4xl font-extrabold ${balanceAtStartOfMonth >= 0 ? 'text-green-700' : 'text-red-700'} drop-shadow-sm`;
            }
        }

        /**
         * Renders the monthly spending overview as a table.
         */
        function renderMonthlyChart() {
            if (!monthlyChartContainer) return;

            const data = {};
            appState.transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const monthYear = `${transactionDate.getFullYear()}-${(transactionDate.getMonth() + 1).toString().padStart(2, '0')}`;
                if (!data[monthYear]) {
                    data[monthYear] = { month: monthYear, credit: 0, debit: 0 };
                }
                if (transaction.type === 'credit') {
                    data[monthYear].credit += transaction.amount;
                } else {
                    data[monthYear].debit += transaction.amount;
                }
            });
            const monthlyData = Object.values(data).sort((a, b) => a.month.localeCompare(b.month));

            monthlyChartContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-2xl">
                    <h3 class="text-2xl font-bold text-gray-800 mb-5">Monthly Spending Overview</h3>
                    ${monthlyData.length === 0 ? `
                        <p class="text-gray-500 text-center py-4">Add transactions to see the chart!</p>
                    ` : `
                        <div class="w-full overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gradient-to-r from-blue-50 to-indigo-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider rounded-tl-lg">Month</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">Credit</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider rounded-tr-lg">Debit</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-100">
                                    ${monthlyData.map(item => `
                                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                                            <td class="px-4 py-3 whitespace-nowrap text-base font-medium text-gray-900">${item.month}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-base text-green-600">‚Çπ${item.credit.toFixed(2)}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-base text-red-600">‚Çπ${item.debit.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        /**
         * Renders spending by category as a table.
         */
        function renderCategorySpendChart() {
            if (!categorySpendChartContainer) return;

            const data = {};
            appState.transactions.forEach(transaction => {
                if (transaction.type === 'debit' && transaction.category) {
                    data[transaction.category] = (data[transaction.category] || 0) + transaction.amount;
                }
            });
            const categoryData = Object.keys(data).map(categoryName => ({
                category: categoryName,
                amount: data[categoryName]
            })).sort((a, b) => b.amount - a.amount);

            categorySpendChartContainer.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-2xl">
                    <h3 class="text-2xl font-bold text-gray-800 mb-5">Spending by Category (Debit)</h3>
                    ${categoryData.length === 0 ? `
                        <p class="text-gray-500 text-center py-4">Add debit transactions with categories to see this chart!</p>
                    ` : `
                        <div class="w-full overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gradient-to-r from-teal-50 to-cyan-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-teal-700 uppercase tracking-wider rounded-tl-lg">Category</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-teal-700 uppercase tracking-wider rounded-tr-lg">Total Spent</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-100">
                                    ${categoryData.map(item => `
                                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                                            <td class="px-4 py-3 whitespace-nowrap text-base font-medium text-gray-900">${item.category}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-right text-base text-red-600">‚Çπ${item.amount.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        /**
         * Renders historical monthly data.
         */
        function renderHistoricalData() {
            if (!historicalDataContent) return;

            const grouped = {};
            const sortedTransactions = [...appState.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Calculate running balance and group by month
            let runningBalance = 0;
            sortedTransactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const monthYear = `${transactionDate.getFullYear()}-${(transactionDate.getMonth() + 1).toString().padStart(2, '0')}`;
                
                // If this is the first transaction for this month, calculate starting balance
                if (!grouped[monthYear]) {
                    // Calculate previous month's ending balance
                    const previousMonths = Object.keys(grouped).sort();
                    const lastMonthKey = previousMonths.length > 0 ? previousMonths[previousMonths.length - 1] : null;
                    const previousMonthEndBalance = lastMonthKey ? grouped[lastMonthKey].endingBalance : 0;

                    grouped[monthYear] = {
                        month: monthYear,
                        totalCredit: 0,
                        totalDebit: 0,
                        startingBalance: previousMonthEndBalance, // Balance from end of prior month
                        endingBalance: previousMonthEndBalance,   // Initialize ending with starting
                        transactions: []
                    };
                }

                if (transaction.type === 'credit') {
                    grouped[monthYear].totalCredit += transaction.amount;
                    grouped[monthYear].endingBalance += transaction.amount;
                } else {
                    grouped[monthYear].totalDebit += transaction.amount;
                    grouped[monthYear].endingBalance -= transaction.amount;
                }
                grouped[monthYear].transactions.push(transaction);
            });

            // Sort months in descending order for display
            const historicalMonthlyData = Object.values(grouped).sort((a, b) => b.month.localeCompare(a.month));

            historicalDataContent.innerHTML = ''; // Clear previous content

            if (historicalMonthlyData.length === 0) {
                historicalDataContent.innerHTML = `<p class="text-center text-gray-700 text-xl bg-white p-8 rounded-xl shadow-xl col-span-full">No historical data available. Please add some transactions on the Home page.</p>`;
            } else {
                historicalMonthlyData.forEach(monthData => {
                    const monthDiv = document.createElement('div');
                    monthDiv.className = "bg-white p-6 rounded-xl shadow-lg border border-blue-200 transform transition-transform duration-300 hover:scale-103 hover:shadow-2xl flex flex-col justify-between";
                    monthDiv.innerHTML = `
                        <div>
                            <h3 class="text-3xl font-bold text-indigo-800 mb-3">${monthData.month}</h3>
                            <div class="space-y-2 mb-4">
                                <p class="flex justify-between items-center text-lg text-gray-700">
                                    <span class="font-medium">Starting Balance:</span>
                                    <span class="${monthData.startingBalance >= 0 ? 'text-green-600' : 'text-red-600'} font-bold">‚Çπ${monthData.startingBalance.toFixed(2)}</span>
                                </p>
                                <p class="flex justify-between items-center text-lg text-gray-700">
                                    <span class="font-medium">Total Credit:</span>
                                    <span class="text-green-600 font-bold">‚Çπ${monthData.totalCredit.toFixed(2)}</span>
                                </p>
                                <p class="flex justify-between items-center text-lg text-gray-700">
                                    <span class="font-medium">Total Debit:</span>
                                    <span class="text-red-600 font-bold">‚Çπ${monthData.totalDebit.toFixed(2)}</span>
                                </p>
                            </div>
                        </div>
                        <div class="p-4 rounded-lg mt-auto text-center ${monthData.endingBalance >= 0 ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}">
                            <h4 class="text-lg font-semibold mb-1">Ending Balance:</h4>
                            <p class="text-3xl font-extrabold">‚Çπ${monthData.endingBalance.toFixed(2)}</p>
                        </div>
                    `;
                    historicalDataContent.appendChild(monthDiv);
                });
            }
        }

        /**
         * Renders the category list on the settings page.
         */
        function renderCategoriesList() {
            if (!categoriesList) return;

            categoriesList.innerHTML = ''; // Clear existing list

            if (appState.categories.length === 0) {
                const noCategoriesMsg = document.createElement('p');
                noCategoriesMsg.className = "text-gray-500 text-center py-6 text-lg";
                noCategoriesMsg.textContent = "No categories added yet.";
                categoriesList.appendChild(noCategoriesMsg);
            } else {
                appState.categories.forEach(category => {
                    const listItem = document.createElement('li');
                    listItem.className = "flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-100 transition-colors duration-150 hover:bg-gray-100";
                    listItem.innerHTML = `
                        <span class="text-lg font-medium text-gray-800">${category.name}</span>
                        <button data-category-id="${category.id}" class="delete-category-btn px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-red-600 transition-colors duration-200">
                            Delete
                        </button>
                    `;
                    categoriesList.appendChild(listItem);
                });

                // Attach event listeners to newly created delete buttons
                categoriesList.querySelectorAll('.delete-category-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const categoryId = event.target.dataset.categoryId;
                        showConfirmationModal("Are you sure you want to delete this category? This will not affect existing transactions that used this category.", () => {
                            handleDeleteCategory(categoryId);
                        });
                    });
                });
            }

            // Update category select dropdown on Home page
            if (transactionCategorySelect) {
                transactionCategorySelect.innerHTML = '';
                if (appState.categories.length === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No categories. Add in Settings.";
                    transactionCategorySelect.appendChild(option);
                    transactionCategorySelect.disabled = true; // Disable if no categories
                } else {
                    transactionCategorySelect.disabled = false;
                    appState.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = cat.name;
                        transactionCategorySelect.appendChild(option);
                    });
                    // Set default selection to the first category if not already set
                    if (!transactionCategorySelect.value && appState.categories.length > 0) {
                        transactionCategorySelect.value = appState.categories[0].name;
                    }
                }
            }
        }

        /**
         * Shows the custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @param {function} onConfirmCallback - Function to call when confirm button is clicked.
         */
        function showConfirmationModal(message, onConfirmCallback) {
            confirmationMessage.textContent = message;
            confirmationModal.classList.remove('hidden');

            // Store the callback
            appState.onConfirmCallback = onConfirmCallback;
        }

        /**
         * Hides the custom confirmation modal.
         */
        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            appState.onConfirmCallback = null; // Clear the callback
        }


        // --- Firebase Core Initialization & Authentication ---

        // ====================================================================================================
        // IMPORTANT: IMPORTANT: IMPORTANT: IMPORTANT: IMPORTANT: IMPORTANT: IMPORTANT: IMPORTANT: IMPORTANT:
        // ====================================================================================================
        // YOU MUST REPLACE THIS ENTIRE `firebaseConfig` OBJECT WITH YOUR ACTUAL FIREBASE PROJECT CONFIG!
        // THIS IS THE MOST COMMON CAUSE OF '400 Bad Request' AND DATA NOT SAVING/LOADING.
        //
        // Steps to get your correct config:
        // 1. Go to your Firebase project in the Google Cloud Console (console.firebase.google.com).
        // 2. Make sure you are in the 'homespendanalyzer' project.
        // 3. Navigate to "Project settings" (gear icon) -> "General" tab.
        // 4. Scroll down to "Your apps" section.
        // 5. Click on the web app (or add one if you haven't).
        // 6. Copy the "Firebase SDK snippet" -> "Config" object and paste it below,
        //    replacing the entire `const firebaseConfig = { ... };` block.
        //
        // Example of a correct config (DO NOT COPY THESE VALUES, THEY ARE GENERIC EXAMPLES):
        // const firebaseConfig = {
        //     apiKey: "AIzaSyC2dF0P1qR3sT4uV5wX6yZ7aB8c-9D0eF1gH2iJ3kL4mN5oP6qR7sT8uV9wX",
        //     authDomain: "your-actual-project-id.firebaseapp.com",
        //     projectId: "your-actual-project-id",
        //     storageBucket: "your-actual-project-id.appspot.com",
        //     messagingSenderId: "1234567890",
        //     appId: "1:1234567890:web:abcdef1234567890abcdef",
        //     measurementId: "G-ABCDEFG"
        // };
        // ====================================================================================================

        const firebaseConfig = {
            apiKey: "AIzaSyBnFqQkfeWdvM18XM3yf1yrcdfTy0X2574", // <--- REPLACE THIS PLACEHOLDER API KEY!
            authDomain: "homespendanalyzer.firebaseapp.com",
            projectId: "homespendanalyzer",
            storageBucket: "homespendanalyzer.firebasestorage.app",
            messagingSenderId: "473397654977",
            appId: "1:473397654977:web:4c4841dcff297f1eb02b40",
            measurementId: "G-GP9HTJSRLH" // Optional, remove if not using Analytics
        };

        const APP_ID = 'homespendanalyzer'; // This should match your projectId or be a consistent identifier for your app's data root

        // Check if Firebase config is valid before proceeding
        if (Object.values(firebaseConfig).some(val => val === null || (typeof val === 'string' && (val.includes("AIzaSyBnFqQkfeWdvM18XM3yf1yrcdfTy0X2574") || val.includes("YOUR_") || val.includes("homespendanalyzer"))))) {
            console.error("Firebase config appears to be default/placeholder or incomplete. Data persistence will NOT work.");
            showAlert("Error: Firebase config is likely incorrect. Please update firebaseConfig in index.html with your project's actual keys.", 'error');
            appState.loading = false;
            loadingSpinner.style.display = 'none';
            showPage(authPage); // Show auth page even if not configured
        } else {
            const app = initializeApp(firebaseConfig);
            appState.db = getFirestore(app); // Initialize Firestore
            appState.auth = getAuth(app);

            // Authentication state listener - CRITICAL for user session and data loading
            onAuthStateChanged(appState.auth, (user) => {
                console.log("onAuthStateChanged triggered. User object:", user);
                if (user && user.email) {
                    appState.userId = user.uid;
                    currentUserIdSpan.textContent = user.uid;
                    loggedInEmailSpan.textContent = user.email;
                    console.log("User logged in. UID:", appState.userId);

                    // Show main content, and default to home page
                    showPage(homePage);
                    userIdDisplay.style.display = 'block';
                    userEmailDisplay.style.display = 'block';
                    loggedInState.classList.remove('hidden');
                    loginFormState.classList.add('hidden');
                    showAlert(`Logged in as: ${user.email}`, 'success');

                    // Start Firestore listeners for transactions and categories
                    setupFirestoreListeners();
                } else {
                    appState.userId = null;
                    currentUserIdSpan.textContent = '';
                    loggedInEmailSpan.textContent = '';
                    console.log("User logged out or no active session. Clearing local data.");

                    // Clear local state and UI elements if no user is logged in
                    appState.transactions = [];
                    appState.categories = [];
                    renderTransactionsTable();
                    updateBalanceDisplays();
                    renderMonthlyChart();
                    renderCategorySpendChart();
                    renderCategoriesList();

                    showPage(authPage); // Always show auth page if not email/password logged in
                    userIdDisplay.style.display = 'none';
                    userEmailDisplay.style.display = 'none';
                    loggedInState.classList.add('hidden');
                    loginFormState.classList.remove('hidden');
                    showAlert('Please log in to continue.', 'info');
                }
                appState.loading = false;
                loadingSpinner.style.display = 'none';
                console.log("Authentication ready. Loading spinner hidden.");
            });
        }

        /**
         * Sets up real-time listeners for transactions and categories once user is authenticated.
         */
        function setupFirestoreListeners() {
            if (!appState.db || !appState.userId) {
                console.warn("Firestore listeners not set up: DB or userId is null. Cannot fetch data.");
                return;
            }
            console.log("Setting up Firestore listeners for userId:", appState.userId);

            // Transactions Listener
            // Data path is artifacts/{APP_ID}/users/{userId}/transactions
            const transactionsCollectionRef = collection(appState.db, `artifacts/${APP_ID}/users/${appState.userId}/transactions`);
            console.log("Attempting to listen to transactions at path (Firestore):", `artifacts/${APP_ID}/users/${appState.userId}/transactions`);
            onSnapshot(query(transactionsCollectionRef), (snapshot) => {
                const fetchedTransactions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Firestore Timestamp to ISO string for date input consistency
                    date: doc.data().date ? new Date(doc.data().date.toDate()).toISOString().slice(0, 10) : new Date().toISOString().slice(0, 10),
                }));
                console.log("Transactions fetched successfully (Firestore):", fetchedTransactions.length, "transactions.");
                appState.transactions = fetchedTransactions;
                renderTransactionsTable();
                updateBalanceDisplays();
                renderMonthlyChart();
                renderCategorySpendChart();
            }, (error) => {
                console.error("Error fetching transactions with onSnapshot (Firestore Security Rules or Network Issue?):", error);
                showAlert(`Failed to load transactions: ${error.message}`, 'error');
            });

            // Categories Listener
            // Data path is artifacts/{APP_ID}/users/{userId}/categories
            const categoriesCollectionRef = collection(appState.db, `artifacts/${APP_ID}/users/${appState.userId}/categories`);
            console.log("Attempting to listen to categories at path (Firestore):", `artifacts/${APP_ID}/users/${appState.userId}/categories`);
            onSnapshot(query(categoriesCollectionRef), (snapshot) => {
                const fetchedCategories = snapshot.docs.map(doc => ({
                    id: doc.id,
                    name: doc.data().name
                }));
                console.log("Categories fetched successfully (Firestore):", fetchedCategories.length, "categories.");
                appState.categories = fetchedCategories;
                renderCategoriesList(); // Re-render categories in settings and dropdown
            }, (error) => {
                console.error("Error fetching categories with onSnapshot (Firestore Security Rules or Network Issue?):", error);
                showAlert(`Failed to load categories: ${error.message}`, 'error');
            });
        }


        // --- Event Handlers ---

        // Custom Alert Close Button
        if (customAlertCloseBtn) {
            customAlertCloseBtn.addEventListener('click', hideAlert);
        }

        // Login Form Submission
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideAlert(); // Clear any previous alerts immediately

                const email = emailInput.value;
                const password = passwordInput.value;

                if (!email || !password) {
                    showAlert('Email and password cannot be empty.', 'error');
                    return;
                }
                if (!appState.auth) {
                    showAlert('Authentication service not available. Check Firebase config.', 'error');
                    return;
                }

                try {
                    console.log(`Attempting login for email: ${email}`);
                    await signInWithEmailAndPassword(appState.auth, email, password);
                    console.log("Login successful in signInWithEmailAndPassword block. onAuthStateChanged will handle UI.");
                    emailInput.value = '';
                    passwordInput.value = '';
                } catch (error) {
                    console.error("Auth Error:", error);
                    showAlert(`Authentication failed: ${error.message}`, 'error');
                }
            });
        }

        // Logout Buttons
        if (navLogoutButton) {
            navLogoutButton.addEventListener('click', async () => {
                hideAlert();
                try {
                    console.log("Attempting logout.");
                    await signOut(appState.auth);
                    console.log("Logout successful. onAuthStateChanged will handle UI.");
                } catch (error) {
                    console.error("Logout Error:", error);
                    showAlert(`Logout failed: ${error.message}`, 'error');
                }
            });
        }
        if (authLogoutButtonAlt) {
            authLogoutButtonAlt.addEventListener('click', async () => {
                hideAlert();
                try {
                    console.log("Attempting logout (alt button).");
                    await signOut(appState.auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                    showAlert(`Logout failed: ${error.message}`, 'error');
                }
            });
        }

        // Go to App button (after initial login if user was already logged in)
        if (goToAppButton) {
            goToAppButton.addEventListener('click', () => {
                console.log("Navigating to Home page from Auth page.");
                showPage(homePage);
                hideAlert(); // Clear any lingering alert
            });
        }

        // Navigation Buttons
        if (navHomeButton) {
            navHomeButton.addEventListener('click', () => {
                console.log("Navigating to Home page.");
                showPage(homePage)
            });
        }
        if (navHistoryButton) {
            navHistoryButton.addEventListener('click', () => {
                console.log("Navigating to History page.");
                showPage(historyPage);
                renderHistoricalData(); // Re-render history when navigating to it
            });
        }
        if (navSettingsButton) {
            navSettingsButton.addEventListener('click', () => {
                console.log("Navigating to Settings page.");
                showPage(settingsPage);
                renderCategoriesList(); // Re-render categories when navigating to it
            });
        }
        if (historyBackButton) {
            historyBackButton.addEventListener('click', () => {
                console.log("Navigating back to Home from History.");
                showPage(homePage)
            });
        }
        if (settingsBackButton) {
            settingsBackButton.addEventListener('click', () => {
                console.log("Navigating back to Home from Settings.");
                showPage(homePage)
            });
        }

        // Transaction Form Submission
        if (transactionForm) {
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideAlert();

                const description = transactionDescriptionInput.value;
                const amount = parseFloat(transactionAmountInput.value);
                const type = document.querySelector('input[name="transactionType"]:checked').value;
                const date = transactionDateInput.value; 
                const category = transactionCategorySelect.value;

                if (!description || isNaN(amount) || amount <= 0 || !date || !category) {
                    showAlert('Please fill in all fields correctly (Description, Amount, Date, Category). Amount must be a positive number.', 'error');
                    return;
                }
                if (!appState.db || !appState.userId) {
                    showAlert('Database not ready or user not logged in. Please try again.', 'error');
                    console.error("Attempted to add transaction but DB or userId is null.", { db: appState.db, userId: appState.userId });
                    return;
                }

                try {
                    const newTransaction = {
                        description,
                        amount,
                        type,
                        date: new Date(date), // Store as Date object for Firestore Timestamp conversion
                        category,
                        createdAt: serverTimestamp(), // Use Firestore serverTimestamp
                    };
                    console.log("Attempting to add new transaction to Firestore:", newTransaction);

                    const transactionsCollectionRef = collection(appState.db, `artifacts/${APP_ID}/users/${appState.userId}/transactions`);
                    await addDoc(transactionsCollectionRef, newTransaction);

                    console.log("Transaction added successfully to Firestore!");
                    showAlert('Transaction added successfully!', 'success');
                    transactionDescriptionInput.value = '';
                    transactionAmountInput.value = '';
                    transactionDateInput.value = new Date().toISOString().slice(0, 10); // Reset date to today
                    document.querySelector('input[name="transactionType"][value="debit"]').checked = true; // Reset type to debit
                    // Category will remain selected or default to first
                } catch (error) {
                    console.error("Error adding transaction to Firestore:", error);
                    showAlert(`Error adding transaction: ${error.message}`, 'error');
                }
            });
        }

        // Add Category Form Submission
        if (addCategoryForm) {
            addCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideAlert();

                const newCategoryName = newCategoryNameInput.value.trim();
                if (!newCategoryName) {
                    showAlert('Category name cannot be empty.', 'error');
                    return;
                }
                if (appState.categories.some(cat => cat.name.toLowerCase() === newCategoryName.toLowerCase())) {
                    showAlert('Category already exists.', 'error');
                    return;
                }
                if (!appState.db || !appState.userId) {
                    showAlert('Database not ready or user not logged in. Please try again.', 'error');
                    console.error("Attempted to add category but DB or userId is null.", { db: appState.db, userId: appState.userId });
                    return;
                }

                try {
                    console.log("Attempting to add new category to Firestore:", { name: newCategoryName });
                    const categoriesCollectionRef = collection(appState.db, `artifacts/${APP_ID}/users/${appState.userId}/categories`);
                    await addDoc(categoriesCollectionRef, { name: newCategoryName, createdAt: serverTimestamp() });
                    console.log("Category added successfully to Firestore!");
                    showAlert('Category added successfully!', 'success');
                    newCategoryNameInput.value = ''; // Clear input
                } catch (error) {
                    console.error("Error adding category to Firestore:", error);
                    showAlert(`Error adding category: ${error.message}`, 'error');
                }
            });
        }

        // Confirmation Modal Buttons
        if (confirmDeleteButton) {
            confirmDeleteButton.addEventListener('click', () => {
                if (appState.onConfirmCallback) {
                    appState.onConfirmCallback(); // Execute stored callback
                }
                hideConfirmationModal();
            });
        }
        if (cancelDeleteButton) {
            cancelDeleteButton.addEventListener('click', hideConfirmationModal);
        }

        /**
         * Handles deletion of a category from Firestore.
         * This function is called by the confirmation modal's callback.
         * @param {string} categoryId - The ID of the category to delete.
         */
        async function handleDeleteCategory(categoryId) {
            if (!appState.db || !appState.userId) {
                showAlert('Database not ready or user not logged in. Cannot delete category.', 'error');
                console.error("Attempted to delete category but DB or userId is null.", { db: appState.db, userId: appState.userId });
                return;
            }
            try {
                console.log("Attempting to delete category with ID (Firestore):", categoryId);
                const categoryDocRef = doc(appState.db, `artifacts/${APP_ID}/users/${appState.userId}/categories`, categoryId);
                await deleteDoc(categoryDocRef);
                console.log("Category deleted successfully from Firestore!");
                showAlert('Category deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting category from Firestore:", error);
                showAlert(`Error deleting category: ${error.message}`, 'error');
            }
        }

        // Initialize default date for transaction form
        if (transactionDateInput) {
            transactionDateInput.value = new Date().toISOString().slice(0, 10);
        }

        // Initial setup on window load
        window.onload = () => {
            // The Firebase onAuthStateChanged listener handles the initial page display
            // and loading spinner automatically.
            // If Firebase config is bad, an alert is shown, and loading spinner hidden.
            // Otherwise, it waits for auth state to determine the page.
        };

    </script>
</body>
</html>

